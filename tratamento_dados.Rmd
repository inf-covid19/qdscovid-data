---
title: "Tratamendo de dados do dataset e-SUS Notifica"
author: Juan Carlos Carbajal Ipenza
output: html_notebook
---

### A moda

```{r}
getMode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}
```


## Importar dados, strings vazios como NA, strings como fatores

### Importando dados

```{r}
dados = read.csv("dados/dados-rs-1.csv", sep = ";", na.strings = "", stringsAsFactors = T, colClasses = c("character", "Date", "Date", "NULL", "NULL", "factor", "NULL", "NULL", "factor", "Date", "factor", "factor", "NULL", "factor", "NULL", "factor", "NULL", "factor", "NULL", "NULL", "NULL", "factor", "NULL", "factor", "NULL", "NULL", "character", "Date", "factor", "factor"))
head(dados)
```

### Corrigindo nomes das colunas

```{r}
colnames(dados)[1] = "id"
colnames(dados)
```

## Explorarando dados categóricos

### Profissional de saúde 

```{r}
summary(dados$profissionalSaude)
counts = table(dados$profissionalSaude)
barplot(counts, main = "Proffisional de saúde", xlab = "Proffisional de saúde")
```

### Sexo 

```{r}
summary(dados$sexo)
counts = table(dados$sexo)
barplot(counts, main = "Sexo", xlab = "Sexo")
```

### Estado do teste

```{r}
summary(dados$estadoTeste)
counts = table(dados$estadoTeste)
barplot(counts, main = "Estado do teste", xlab = "Estado do teste")
```


### Tipo de teste

```{r}
summary(dados$tipoTeste)
counts = table(dados$tipoTeste)
barplot(counts, main = "Tipo de teste", xlab = "Tipo de teste")
```

### Resultado do teste

```{r}
summary(dados$resultadoTeste)
counts = table(dados$resultadoTeste)
barplot(counts, main = "Resultado do teste", xlab = "Resultado do teste")
```

### Evolução do caso

```{r}
summary(dados$evolucaoCaso)
counts = table(dados$evolucaoCaso)
barplot(counts, main = "Evolução do casoe", xlab = "Evolução do caso")
```

### Classificação final

```{r}
summary(dados$classificacaoFinal)
counts = table(dados$classificacaoFinal)
barplot(counts, main = "Classificação final", xlab = "Classificação final")
```

### Estado de residência

```{r}
summary(dados$estadoIBGE)
counts = table(dados$estadoIBGE)
barplot(counts, main = "Estado de residência", xlab = "Estado de residência")
```

### Municipio de residência

```{r}
summary(dados$municipioIBGE)
counts = table(dados$municipioIBGE)
barplot(counts, main = "Municipio de residência", xlab = "Municipio de residência")
```

### Estado de notificação

```{r}
summary(dados$estadoNotificacaoIBGE)
counts = table(dados$estadoNotificacaoIBGE)
barplot(counts, main = "Estado de notificação", xlab = "Estado de notificação")
```

### Municipio de notificação

```{r}
summary(dados$municipioNotificacaoIBGE)
counts = table(dados$municipioNotificacaoIBGE)
barplot(counts, main = "Municipio de notificação", xlab = "Municipio de notificação")
```

## Explorando dados temporais

### Data do início dos síntomas

```{r}
summary(dados$dataInicioSintomas)
counts = table(dados$dataInicioSintomas)
barplot(counts, main = "Data do início dos síntomas", xlab = "Data do início dos síntomas")
```

### Data da notificação

```{r}
summary(dados$dataNotificacao)
counts = table(dados$dataNotificacao)
barplot(counts, main = "Data da notificação", xlab = "Data da notificação")
```

### Data do teste

```{r}
summary(dados$dataTeste)
counts = table(dados$dataTeste)
barplot(counts, main = "Data do teste", xlab = "Data do teste")
```

### Data de encerramento

```{r}
summary(dados$dataEncerramento)
counts = table(dados$dataEncerramento)
barplot(counts, main = "Data de encerramento", xlab = "Data de encerramento")
```

## Valores faltantes - NAs

```{r}
dim(dados[!complete.cases(dados),])[1]
```

## Tratamento e limpeza dos dados

### Profissional de saúde

Campo obrigatório. A dimensão tem o problema de ter dados fora de domínio e nulos. Pela documentação só são aceitos:

- Sim
- Não

```{r}
unique(dados$profissionalSaude)
dados[!dados$profissionalSaude %in% c("Sim", "Não"),]$profissionalSaude = getMode(dados$profissionalSaude)

summary(dados$profissionalSaude)
dados$profissionalSaude = factor(dados$profissionalSaude)
summary(dados$profissionalSaude)
```

### Idade

Campo obrigatório. A dimensão tem muitos dados fora do domínio e tambvém tem nulos.

Transformando os dados a inteiros. Temos dados nulos.

```{r}
dim(dados[!complete.cases(dados$idade),])[1]
unique(dados[is.na(as.numeric(dados$idade)),]$idade)
dados = transform(dados, idade = as.integer(idade))
```
Vendo o conteúdo dos dados

```{r}
summary(dados$idade)
boxplot(dados$idade)
hist(dados$idade)
```

Segundo o Gerontology Research Group (GRG) a idade do brasileiro mais velhor vivo é de 116 anos ([GRG News announces new Brazil oldest person record](https://grg.org/GRGNews2020.html)).

```{r}
dados[dados$idade < 0 | dados$idade > 116,]$idade
dados[is.na(dados$idade),]$idade

median(dados[dados$idade >= 0 & dados$idade <= 116,]$idade, na.rm = T)

dados[is.na(dados$idade) | dados$idade < 0 | dados$idade > 116,]$idade = median(dados[dados$idade >= 0 & dados$idade <= 116,]$idade, na.rm = T)

dados[dados$idade < 0 | dados$idade > 116,]$idade
summary(dados$idade)
```

### Sexo

Campo obrigatório. A dimensão tem o problema de ter dados fora de domínio e nulos. Pela documentação só são aceitos:

- Feminino
- Masculino

```{r}
unique(dados$sexo)
dados[!dados$sexo %in% c("Feminino", "Masculino"),]$sexo = getMode(dados$sexo)

summary(dados$sexo)
dados$sexo = factor(dados$sexo)
summary(dados$sexo)
```

### Estado do teste

A dimensão tem o problema de ter dados nulos. Pela documentação só são aceitos:

- Solicitado
- Coletado
- Concluído
- Exame Não Solicitado

Foi adicionado o nivel **Indefinido** para os dados nulos.

```{r}
unique(dados$estadoTeste)

summary(dados[is.na(dados$estadoTeste) | dados$estadoTeste %in% c("null", "undefined"),]$estadoTeste)
levels(dados$estadoTeste) = c(levels(dados$estadoTeste), "Indefinido")
dados[is.na(dados$estadoTeste) | dados$estadoTeste %in% c("null", "undefined"),]$estadoTeste = "Indefinido"

summary(dados$estadoTeste)
dados$estadoTeste = factor(dados$estadoTeste)
summary(dados$estadoTeste)
```


### Tipo de teste

A dimensão tem o problema de ter dados com falta de padronização e nulos. Pela documentação só são aceitos:

- RT-PCR
- TESTE RÁPIDO - ANTICORPO
- TESTE RÁPIDO - ANTÍGENO
- Enzimaimunoensaio - ELISA IgM
- Imunoensaio por Eletroquimioluminescência - ECLIA IgG
- Quimioluminescência - CLIA.

Foi adicionado o nivel **Indefinido** para os dados nulos.

```{r}
unique(dados$tipoTeste)

summary(dados[is.na(dados$tipoTeste) | dados$tipoTeste %in% c("null", "undefined"),]$tipoTeste)
levels(dados$tipoTeste) = c(levels(dados$tipoTeste), "Indefinido")
dados[is.na(dados$tipoTeste) | dados$tipoTeste %in% c("null", "undefined"),]$tipoTeste = "Indefinido"

dados[dados$tipoTeste == "Enzimaimunoensaio \023 ELISA",]$tipoTeste = "Enzimaimunoensaio - ELISA IgM"
dados[dados$tipoTeste == "Imunoensaio por Eletroquimioluminescência \023 ECLIA",]$tipoTeste = "Imunoensaio por Eletroquimioluminescência - ECLIA IgG"

summary(dados$tipoTeste)
dados$tipoTeste = factor(dados$tipoTeste)
summary(dados$tipoTeste)
```

### Resultado do teste

A dimensão tem o problema de ter dados nulos. Pela documentação só são aceitos:

- Negativo
- Positivo
- Inconclusivo ou Indeterminado

Foi adicionado o nivel **Indefinido** para os dados nulos.

```{r}
unique(dados$resultadoTeste)

summary(dados[is.na(dados$resultadoTeste) | dados$resultadoTeste %in% c("null", "undefined"),]$resultadoTeste)
levels(dados$resultadoTeste) = c(levels(dados$resultadoTeste), "Indefinido")
dados[is.na(dados$resultadoTeste) | dados$resultadoTeste %in% c("null", "undefined"),]$resultadoTeste = "Indefinido"

summary(dados$resultadoTeste)
dados$resultadoTeste = factor(dados$resultadoTeste)
summary(dados$resultadoTeste)
```

### Evolução do caso

A dimensão tem o problema de ter NAs. Pela documentação só são aceitos:

- Cancelado
- Ignorado
- Em tratamento domiciliar
- Internado em UTI
- Internado
- Óbito
- Cura

Foi adicionado o nivel **Indefinido** para os dados nulos.

```{r}
unique(dados$evolucaoCaso)

summary(dados[is.na(dados$evolucaoCaso),]$evolucaoCaso)
levels(dados$evolucaoCaso) = c(levels(dados$evolucaoCaso), "Indefinido")
dados[is.na(dados$evolucaoCaso),]$evolucaoCaso = "Indefinido"

summary(dados$evolucaoCaso)
dados$evolucaoCaso = factor(dados$evolucaoCaso)
summary(dados$evolucaoCaso)
```

### Classificação final

A dimensão tem o problema de ter dados com falta de padronização e nulos. Pela documentação só são aceitos:

- Descartado                        
- Confirmado Clínico-Imagem
- Confirmado Clínico-Epidemiológico
- Confirmado por Critério Clínico
- Confirmado Laboratorial
- Síndrome Gripal Não Especificada

Foi adicionado o nivel **Indefinido** para os dados nulos.

```{r}
unique(dados$classificacaoFinal)

summary(dados[is.na(dados$classificacaoFinal),]$classificacaoFinal)
levels(dados$classificacaoFinal) = c(levels(dados$classificacaoFinal), "Indefinido")
dados[is.na(dados$classificacaoFinal),]$classificacaoFinal = "Indefinido"

dados[dados$classificacaoFinal == "Confirmação Laboratorial",]$classificacaoFinal = "Confirmado Laboratorial"

summary(dados$classificacaoFinal)
dados$classificacaoFinal = factor(dados$classificacaoFinal)
summary(dados$classificacaoFinal)
```

### Id

Procurando se temos registros duplicados. Não temos.

```{r}
dados[duplicated(dados$Id),]
```

### Data do início dos síntomas

Campo obrigatório. A dimensão está fora do domínio. O paciente zero viajou para a Itália entre o 9 e 21 de fevereiro do 2020. Então a data do início dos síntomas mínima possível seria o 9 de fevereiro ([Primeiro caso confirmado de Covid-19 no Brasil ocorreu em SP e completa seis meses nesta quarta](https://g1.globo.com/sp/sao-paulo/noticia/2020/08/26/primeiro-caso-confirmado-de-covid-19-no-brasil-ocorreu-em-sp-e-completa-seis-meses-nesta-quarta.ghtml)). E a máxima data seria a data atual.

```{r}
correctInterval = dados$dataInicioSintomas >= "2020-02-09" & dados$dataInicioSintomas <= Sys.Date() & !is.na(dados$dataInicioSintomas)
median_dataInicioSintomas = median(dados[correctInterval,]$dataInicioSintomas)

dados[!correctInterval,]$dataInicioSintomas = median_dataInicioSintomas

summary(dados$dataInicioSintomas)
```

### Data da notificação

Campo obrigatório. A dimensão está fora do domínio. O paciente zero viajou para a Itália entre o 9 e 21 de fevereiro do 2020. Então a data da notificação mínima possível seria quando ele voltou ao Brasil o 21 de fevereiro ([Primeiro caso confirmado de Covid-19 no Brasil ocorreu em SP e completa seis meses nesta quarta](https://g1.globo.com/sp/sao-paulo/noticia/2020/08/26/primeiro-caso-confirmado-de-covid-19-no-brasil-ocorreu-em-sp-e-completa-seis-meses-nesta-quarta.ghtml)). E a máxima data seria a data atual.

```{r}
correctInterval = dados$dataNotificacao >= "2020-02-21" & dados$dataNotificacao <= Sys.Date() & !is.na(dados$dataNotificacao)
median_dataNotificacao = median(dados[correctInterval,]$dataNotificacao)

dados[!correctInterval,]$dataNotificacao = median_dataNotificacao

summary(dados$dataNotificacao)
```

### Data do teste

A dimensão está fora do domínio. O paciente zero viajou para a Itália entre o 9 e 21 de fevereiro do 2020. Então a data do teste mínima possível seria quando ele voltou ao Brasil o 21 de fevereiro ([Primeiro caso confirmado de Covid-19 no Brasil ocorreu em SP e completa seis meses nesta quarta](https://g1.globo.com/sp/sao-paulo/noticia/2020/08/26/primeiro-caso-confirmado-de-covid-19-no-brasil-ocorreu-em-sp-e-completa-seis-meses-nesta-quarta.ghtml)). E a máxima data seria a data atual.

```{r}
correctInterval = dados$dataTeste >= "2020-02-21" & dados$dataTeste <= Sys.Date() & !is.na(dados$dataTeste)

dados[!correctInterval,]$dataTeste = "2020-01-01"

summary(dados$dataTeste)
```

### Data de encerramento

A dimensão está fora do domínio. O paciente zero viajou para a Itália entre o 9 e 21 de fevereiro do 2020. Então a data de encerramento mínima possível seria quando ele voltou ao Brasil o 21 de fevereiro ([Primeiro caso confirmado de Covid-19 no Brasil ocorreu em SP e completa seis meses nesta quarta](https://g1.globo.com/sp/sao-paulo/noticia/2020/08/26/primeiro-caso-confirmado-de-covid-19-no-brasil-ocorreu-em-sp-e-completa-seis-meses-nesta-quarta.ghtml)). E a máxima data seria a data atual.

```{r}
correctInterval = dados$dataEncerramento >= "2020-02-21" & dados$dataEncerramento <= Sys.Date() & !is.na(dados$dataEncerramento)

dados[!correctInterval,]$dataEncerramento = "2020-01-01"

summary(dados$dataEncerramento)
```

## Últimas modificações

Deletando a coluna dos IDs

```{r}
dados$id = NULL
```

## Resultado final dos dados

```{r}
head(dados)
summary(dados)
```































